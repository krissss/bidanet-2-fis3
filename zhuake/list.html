<link rel="import" href="../components/head.html?__inline">

<div class="container">
	<div class="map-head">
		<span class="vertical-line"></span>客资列表
		<div class="filter">
			<select class="form-control input-sm customer-status">
      </select>
		</div>
	</div>
	<table class="table table-bordered table-striped table-small">
		<thead>
			<tr>
				<th class="table-th-width-44">序号</th>
				<th class="table-th-width-65">姓名</th>
				<th>抓取日期</th>
				<th class="table-th-width-44">类别</th>
				<th>客资状态</th>
			</tr>
		</thead>
		<tbody id="table-content">
		</tbody>
	</table>

</div>

<script>
	iframe.init();
</script>

<script>
  var searchParams =  {
    customer_service_id: api.userInfo.userUuid
  },
  // 以下两个暂时预留不用
  pageIndex = request.getParam('pageIndex')?request.getParam('pageIndex'):0,
  pageSize = request.getParam('pageSize')?request.getParam('pageSize'):999;

  // 下拉筛选
  $('.customer-status').html(api.getCustomerStatusOptions([-1,1,2,3,4,5,6,7,8,9,10,14]));

  // 筛选事件
  $('.customer-status').change(function(){
    var value = parseInt($(this).val());
    if(value == -1){
      delete searchParams['customer_user_status'];
    }else{
      searchParams['customer_user_status'] = value;
    }
    setTableList(searchParams, pageIndex, pageSize);
  });

  // 有效无效的点击事件
  $('.validate-flag').click(function(){
    $('.validate-flag').removeClass('btn-primary').addClass('btn-default');
    $(this).addClass('btn-primary');
    var value = parseInt($(this).data('validate'));
    if(value == -1){
      delete searchParams['valid_flag'];
    }else{
      searchParams['valid_flag'] = value;
    }
    setTableList(searchParams, pageIndex, pageSize);
  });

  // 初始化加载数据
  setTableList(searchParams, pageIndex, pageSize);
  
  // 设置表格数据
  function setTableList(searchParams, pageIndex, pageSize){
    api.listObject('BusCustomer', searchParams, pageIndex, pageSize, function(data){
      var tabelTbody = '',
          createTime,
          customerFlagName,
          statusName;
      if(data){
        $.each(data.list, function(index, item){
          // 格式化数据
          createTime = new Date(item.zkcreateTime).format("yyyy-MM-dd\nhh:mm:ss");
          customerFlagName = api.getCustomerFlagName(item.customerFlag);
          statusName = api.getStatusName(item.customerUserStatus, item.validFlag);
          // 构造table body
          tabelTbody +=
          '<tr onclick="javascript:window.location.href=\'detail.html?id='+ item.uuid +'\'">'
            + '<td>'+ (index+1) +'</td>'
            + '<td width="65">'+ item.name1 +'</td>'
            + '<td>'+ createTime +'</td>'
            + '<td>'+ customerFlagName +'</td>'
            + '<td>'+ statusName +'</td>'
            + '</tr>'
            + "\n";
        });
      }
      // 一次性加到页面上
      $('#table-content').html(tabelTbody);
      // 重新设定 iframe 高度
      iframe.changeHeight();
    });
  }
  
</script>

<link rel="import" href="../components/foot.html?__inline">