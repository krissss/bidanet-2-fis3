<link rel="import" href="../components/head-iframe.html?__inline">

<div class="container">
	<div class="map-head"><span class="vertical-line"></span><span id="operate-text">新增</span>客资</div>
	<div class="panel panel-primary">
		<form id="form" action="" class="form-horizontal form" role="form">
			<div class="panel-body">
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 称呼
          </label>
					<div class="col-xs-8 no-padding-left">
						<input name="name" type="text" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 渠道
          </label>
					<div class="col-xs-4 no-padding-left">
						<select name="channel_id" class="form-control">
            </select>
					</div>
					<div class="col-xs-4 no-padding-left">
						<select name="channel_way_id" class="form-control">
            </select>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 地区
          </label>
					<div class="col-xs-8 no-padding-left">
						<select name="location_id" class="form-control">
            </select>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 类别
          </label>
					<div class="col-xs-8 no-padding-left">
						<select name="customer_flag" class="form-control">
              <option value="">请选择</option>
              <option value="1">A</option>
              <option value="2">B</option>
              <option value="3">C</option>
              <option value="4">D</option>
            </select>
					</div>
				</div>
			</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 手机
          </label>
					<div class="col-xs-8 no-padding-left">
						<input name="tel" type="text" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 微信
          </label>
					<div class="col-xs-8 no-padding-left">
						<input name="wechat" type="text" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> Q Q
          </label>
					<div class="col-xs-8 no-padding-left">
						<input name="qq" type="text" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label no-padding-left">
            <span class="icon glyphicon glyphicon-search"></span> 身份
          </label>
					<div class="col-xs-8 no-padding-left">
						<input name="name_flag" type="text" class="form-control">
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-4 control-label">
            沟通记录
          </label>
					<div class="col-xs-12">
						<textarea name="zkrecord" class="form-control" rows="3"></textarea>
					</div>
				</div>

				<div class="form-group">
					<div class="col-xs-offset-2 col-xs-8">
						<input type="submit" class="btn btn-primary btn-block" value="提交">
					</div>
				</div>
			</div>
		</form>
	</div>
</div>

<script>
	iframe.init();
</script>

<script>
	var type = request.getParam('type'),
			customerUuid = request.getParam('id');
		
	if(type == 'update'){
		$('#operate-text').text('更新');
	}

	var channelLoaded = false,
			locationLoaded = false,
			// 用定时器检测select是否加载完成
			isSelectLoaded = setInterval(function(){
				if(channelLoaded && locationLoaded){
					// 清除定时器
					window.clearInterval(isSelectLoaded);
					// 是更新则获取客资信息然后填充表单
					if(type == 'update'){
						api.getObject('BusCustomer', customerUuid, function(data){
							if(data.retMsg == 'OK'){
								var obj = data.retVal;
								$('input[name=name]').val(obj.name1);
								$('select[name=channel_id]').val(obj.channel_id);
								$('select[name=location_id]').val(obj.location_id);
								$('select[name=customer_flag]').val(obj.customer_flag);
								$('input[name=tel]').val(obj.tel1);
								$('input[name=wechat]').val(obj.wechat1);
								$('input[name=qq]').val(obj.qq1);
								$('input[name=name_flag]').val(obj.name_flag);
								$('textarea[name=zkrecord]').val(obj.zkrecord);
							}else{
								alert(data.retMsg);
							}
						});
					}
				}
			}, 1000);

  // 渠道
  api.listIdAndName('BusChannel', function(options){
    $('select[name=channel_id]').append(options);
		channelLoaded = true;
  });

	// 渠道方式级联更改
	$('select[name=channel_id]').change(function(){
		$('select[name=channel_way_id]').val();
		// 渠道方式
		api.listIdAndNameNoToken('BusChannelWay', {
			channel_id: $(this).val()
		}, function(options){
			$('select[name=channel_way_id]').html(options);
		});
	});
	

  // 地区
  api.listIdAndName('BusLocation', function(options){
    $('select[name=location_id]').append(options);
		locationLoaded = true;
  });
  
  // 表单提交
  $('#form').submit(function(){
    var params = {};
    // 表单数据
		params['name1'] = $('input[name=name]').val();
		params['channel_id'] = $('select[name=channel_id]').val();
		params['channel_way_id'] = $('select[name=channel_way_id]').val();
		params['location_id'] = $('select[name=location_id]').val();
		params['customer_flag'] = $('select[name=customer_flag]').val();
		params['tel1'] = $('input[name=tel]').val();
		params['wechat1'] = $('input[name=wechat]').val();
		params['qq1'] = $('input[name=qq]').val();
		params['name_flag'] = $('input[name=name_flag]').val();
		params['zkrecord'] = $('textarea[name=zkrecord]').val();
		// 如果是更新
		if(type == 'update'){
			params['uuid'] = customerUuid;
		}else{
			// 非更新需要额外数据
			params['customer_service_id'] = api.userInfo.userUuid;
			params['zkcreate_time'] = new Date().getTime();
			params['customer_user_status'] = 1;
		}
    // 调用接口
    api.saveObject('BusCustomer', params, function(data){
			if(data.retMsg == 'OK'){
				window.location.href = 'add-success.html?id='+data.retVal.uuid;
			}else{
				alert(data.retMsg);
			}
    });
    return false;
  });
</script>

<link rel="import" href="../components/foot-iframe.html?__inline">