<link rel="import" href="../components/head.html?__inline">

<div class="container">
  <div class="map-head">
    <span class="vertical-line"></span>客资列表
    <div class="filter">
      <select class="form-control input-sm customer-status">
      </select>
    </div>
  </div>
  <table class="table table-bordered table-striped table-small">
      <thead>
        <tr>
          <th width="44">序号</th>
          <th width="65">姓名</th>
          <th>接收时间</th>
          <th width="44">类别</th>
          <th>状态</th>
        </tr>
      </thead>
      <tbody id="table-content">
      </tbody>
    </table>

</div>

<script>
	iframe.init();
</script>

<script>
  var searchParams =  {
    invite_id: api.userInfo.userUuid
  },
  // 以下两个暂时预留不用
  pageIndex = request.getParam('pageIndex')?request.getParam('pageIndex'):0,
  pageSize = request.getParam('pageSize')?request.getParam('pageSize'):999;

  // 下拉筛选
  $('.customer-status').html(api.getCustomerStatusOptions([-1,2,3,4,5,6,7,8,9,10,14]));

  // 筛选事件
  $('.customer-status').change(function(){
    var value = parseInt($(this).val());
    if(value == -1){
      delete searchParams['customer_user_status'];
    }else{
      searchParams['customer_user_status'] = value;
    }
    setTableList(searchParams, pageIndex, pageSize);
  });

  // 初始化加载数据
  setTableList(searchParams, pageIndex, pageSize);
  
  // 设置表格数据
  function setTableList(searchParams, pageIndex, pageSize){
    api.listObject('BusCustomer', searchParams, pageIndex, pageSize, function(data){
      var tabelTbody = '',
          baobeiTime,
          customerFlag,
          customerStatus;
      if(data){
        $.each(data.list, function(index, item){
          // 排除部分数据
          if(item.validFlag == 2){ // 无效客资跳过
            logger('无效客资跳过', item);
            return true;
          }
          if(item.customerUserStatus == 1){ // 未被接收的客资跳过
            logger('未被接收的客资跳过', item);
            return true;
          }
          // 格式化数据
          baobeiTime = api.getFormatDate(item.yycreateTime, "yyyy-MM-dd\nhh:mm:ss");
          customerFlag = api.getCustomerFlagName(item.customerFlag);
          customerStatus = api.getStatusName(item.customerUserStatus);
          // 构造table body
          tabelTbody +=
          '<tr onclick="javascript:window.location.href=\'detail.html?id='+ item.uuid +'\'">'
            + '<td>'+ (index+1) +'</td>'
            + '<td width="65">'+ item.name1 +'</td>'
            + '<td>'+ baobeiTime +'</td>'
            + '<td>'+ customerFlag +'</td>'
            + '<td>'+ customerStatus +'</td>'
            + '</tr>'
            + "\n";
        });
      }
      // 一次性加到页面上
      $('#table-content').html(tabelTbody);
      // 重新设定 iframe 高度
      iframe.changeHeight();
    });
  }
  
</script>

<link rel="import" href="../components/foot.html?__inline">