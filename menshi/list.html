<link rel="import" href="../components/head.html?__inline">

<div class="container">
  <div class="map-head">
    <span class="vertical-line"></span>客资列表
    <div class="filter">
      <select class="form-control input-sm customer-status">
      </select>
    </div>
  </div>
  <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>序号</th>
          <th>姓名</th>
          <th>下发时间</th>
          <th>订单</th>
          <th>预计到店时间</th>
        </tr>
      </thead>
      <tbody id="table-content">
      </tbody>
    </table>

</div>

<script>
	iframe.init();
</script>

<script>
  var searchParams =  {
    sales_id: api.userInfo.userUuid
  },
  // 以下两个暂时预留不用
  pageIndex = request.getParam('pageIndex')?request.getParam('pageIndex'):0,
  pageSize = request.getParam('pageSize')?request.getParam('pageSize'):999;

  // 下拉筛选
  $('.customer-status').html(api.getCustomerStatusOptions([-1,6,7,8,9,10]));

  // 筛选事件
  $('.customer-status').change(function(){
    var value = parseInt($(this).val());
    if(value == -1){
      delete searchParams['customer_user_status'];
    }else{
      searchParams['customer_user_status'] = value;
    }
    setTableList(searchParams, pageIndex, pageSize);
  });

  // 初始化加载数据
  setTableList(searchParams, pageIndex, pageSize);
  
  // 设置表格数据
  function setTableList(searchParams, pageIndex, pageSize){
    api.listObject('BusCustomer', searchParams, pageIndex, pageSize, function(data){
      var tabelTbody = '',
          xiafaTime,
          order,
          shopTime;
      if(data){
        $.each(data.list, function(index, item){
          // 排除部分数据
          if(item.customerUserStatus <= 5){ // 未被接收的客资跳过
            logger('未被接收的客资跳过', item);
            return true;
          }
          // 格式化数据
          xiafaTime = api.getFormatDate(item.mscreateTime, "yyyy-MM-dd\nhh:mm:ss");
          order = item.paid ? item.paid : '';
          shopTime = api.getFormatDate(item.shopDate, "yyyy-MM-dd\n") + item.strShopDate;
          // 构造table body
          tabelTbody +=
          '<tr onclick="javascript:window.location.href=\'detail.html?id='+ item.uuid +'\'">'
            + '<td>'+ (index+1) +'</td>'
            + '<td>'+ item.name1 +'</td>'
            + '<td>'+ xiafaTime +'</td>'
            + '<td>'+ order +'</td>'
            + '<td>'+ shopTime +'</td>'
            + '</tr>'
            + "\n";
        });
      }
      // 一次性加到页面上
      $('#table-content').html(tabelTbody);
      // 重新设定 iframe 高度
      iframe.changeHeight();
    });
  }
  
</script>

<link rel="import" href="../components/foot.html?__inline">